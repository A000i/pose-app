<body>
  <h1>動画で骨格推定</h1>
  <input type="file" id="videoUpload" accept="video/*"/>

  <div>
    <button id="videoPlayBtn">▶ 動画再生</button>
    <button id="posePlayBtn">▶ 骨格推定開始</button>
  </div>

  <div class="video-container">
    <video id="video" controls></video>
    <canvas id="output"></canvas>
  </div>

  <!-- ここからコメントカルテUI -->
  <div id="commentSection">
    <h2>コメントカルテ</h2>
    <div id="userInfo">ログインしてコメントしてください</div>
    <button id="loginBtn">Googleでログイン</button>
    <textarea id="commentInput" placeholder="コメントを入力"></textarea>
    <button id="sendComment">送信</button>
    <ul id="commentList"></ul>
  </div>
  <!-- ここまでコメントカルテUI -->

  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.16.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/pose-detection"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/pose-detection/dist/movenet.min.js"></script>
  <script src="script.js" type="module"></script>

  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.1/firebase-app.js";
  import { getFirestore, collection, addDoc, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/10.6.1/firebase-firestore.js";
  import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.6.1/firebase-auth.js";

  // Firebase コンソールからコピーした設定を貼る
  const firebaseConfig = {
    apiKey: "XXXX",
    authDomain: "XXXX.firebaseapp.com",
    projectId: "XXXX",
    storageBucket: "XXXX.appspot.com",
    messagingSenderId: "XXXX",
    appId: "XXXX"
  };

  // Firebase 初期化
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  // HTML要素取得
  const loginBtn = document.getElementById('loginBtn');
  const userInfo = document.getElementById('userInfo');
  const commentInput = document.getElementById('commentInput');
  const sendComment = document.getElementById('sendComment');
  const commentList = document.getElementById('commentList');

  let currentUser = null;

  // Googleログイン
  loginBtn.addEventListener('click', async () => {
    const provider = new GoogleAuthProvider();
    await signInWithPopup(auth, provider);
  });

  onAuthStateChanged(auth, (user) => {
    if (user) {
      currentUser = user;
      userInfo.textContent = `ログイン中: ${user.displayName}`;
      loginBtn.style.display = 'none';
    } else {
      currentUser = null;
      userInfo.textContent = 'ログインしてコメントしてください';
      loginBtn.style.display = 'inline-block';
    }
  });

  // コメント送信
  const VIDEO_ID = 'sample-video'; // 動画やカメラごとにIDを付ける
  const commentsCollection = collection(db, 'comments');

  sendComment.addEventListener('click', async () => {
    if (!currentUser) { alert('ログインしてください'); return; }
    const text = commentInput.value.trim();
    if (!text) return;

    await addDoc(commentsCollection, {
      videoId: VIDEO_ID,
      userId: currentUser.uid,
      userName: currentUser.displayName,
      text: text,
      timestamp: new Date().toISOString()
    });

    commentInput.value = '';
    loadComments();
  });

  // コメント一覧表示
  async function loadComments() {
    commentList.innerHTML = '';
    const q = query(commentsCollection, orderBy('timestamp'));
    const snapshot = await getDocs(q);

    snapshot.forEach(doc => {
      const data = doc.data();
      if (data.videoId === VIDEO_ID) {
        const li = document.createElement('li');
        li.textContent = `${new Date(data.timestamp).toLocaleString()} - ${data.userName}: ${data.text}`;
        commentList.appendChild(li);
      }
    });
  }

  // ページ読み込み時にコメントを表示
  window.onload = () => {
    loadComments();
  };

</script>

</body>

